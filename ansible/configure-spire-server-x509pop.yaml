---
# Configure SPIRE Server to support x509pop node attestation for CoCo pods
# The Red Hat SPIRE Operator's SpireServer CRD does not expose x509pop plugin configuration
# This job patches the operator-generated ConfigMap and StatefulSet to add x509pop support
#
# IMPORTANT: This playbook enables "create-only mode" on the SpireServer CR to prevent
# the operator from reverting our manual patches. This is done via the annotation:
#   ztwim.openshift.io/create-only: "true"
#
# NOTE: The create-only mode is enabled AFTER verifying the ConfigMap has the correct
# cluster name. This prevents a race condition where the operator hasn't fully reconciled
# the ConfigMap before we lock it.

- name: Configure SPIRE Server for x509pop attestation
  become: false
  connection: local
  hosts: localhost
  gather_facts: false
  vars:
    spire_namespace: "zero-trust-workload-identity-manager"
    configmap_name: "spire-server"
    statefulset_name: "spire-server"
    ca_configmap_name: "spire-x509pop-ca"
    ca_mount_path: "/run/spire/x509pop-ca"
  tasks:
    - name: Get SpireServer CR to determine expected cluster name
      kubernetes.core.k8s_info:
        api_version: operator.openshift.io/v1alpha1
        kind: SpireServer
        name: cluster
        namespace: "{{ spire_namespace }}"
      register: spire_server_cr
      retries: 30
      delay: 10
      until: spire_server_cr.resources | length > 0

    - name: Extract expected cluster name from SpireServer CR
      ansible.builtin.set_fact:
        expected_cluster_name: "{{ spire_server_cr.resources[0].spec.clusterName }}"

    - name: Display expected cluster name
      ansible.builtin.debug:
        msg: "Expected cluster name from SpireServer CR: {{ expected_cluster_name }}"

    - name: Wait for SPIRE Server ConfigMap with correct cluster name
      kubernetes.core.k8s_info:
        kind: ConfigMap
        namespace: "{{ spire_namespace }}"
        name: "{{ configmap_name }}"
      register: spire_configmap
      retries: 60
      delay: 5
      until: >
        spire_configmap.resources | length > 0 and
        (spire_configmap.resources[0].data['server.conf'] | from_json).plugins.NodeAttestor[0].k8s_psat.plugin_data.clusters[0][expected_cluster_name] is defined

    - name: ConfigMap has correct cluster name
      ansible.builtin.debug:
        msg: "ConfigMap verified with correct cluster name: {{ expected_cluster_name }}"

    - name: Get current SPIRE Server configuration
      kubernetes.core.k8s_info:
        kind: ConfigMap
        namespace: "{{ spire_namespace }}"
        name: "{{ configmap_name }}"
      register: spire_config

    - name: Parse server configuration
      ansible.builtin.set_fact:
        server_conf: "{{ spire_config.resources[0].data['server.conf'] | from_json }}"

    - name: Check if x509pop already configured
      ansible.builtin.set_fact:
        x509pop_exists: "{{ server_conf.plugins.NodeAttestor | selectattr('x509pop', 'defined') | list | length > 0 }}"

    - name: Add x509pop NodeAttestor plugin
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ configmap_name }}"
            namespace: "{{ spire_namespace }}"
          data:
            server.conf: "{{ server_conf | combine({'plugins': {'NodeAttestor': server_conf.plugins.NodeAttestor + [{'x509pop': {'plugin_data': {'ca_bundle_path': '/run/spire/x509pop-ca/ca-bundle.pem'}}}]}}, recursive=True) | to_json }}"
      when: not x509pop_exists

    - name: Wait for SPIRE Server StatefulSet to exist
      kubernetes.core.k8s_info:
        kind: StatefulSet
        namespace: "{{ spire_namespace }}"
        name: "{{ statefulset_name }}"
      register: spire_statefulset
      retries: 30
      delay: 10
      until: spire_statefulset.resources | length > 0

    - name: Check if CA volume already mounted
      ansible.builtin.set_fact:
        ca_volume_exists: "{{ spire_statefulset.resources[0].spec.template.spec.volumes | selectattr('name', 'equalto', 'x509pop-ca') | list | length > 0 }}"

    - name: Add CA volume to SPIRE Server StatefulSet
      kubernetes.core.k8s:
        state: patched
        kind: StatefulSet
        namespace: "{{ spire_namespace }}"
        name: "{{ statefulset_name }}"
        definition:
          spec:
            template:
              spec:
                volumes:
                  - name: x509pop-ca
                    configMap:
                      name: "{{ ca_configmap_name }}"
                containers:
                  - name: spire-server
                    volumeMounts:
                      - name: x509pop-ca
                        mountPath: "{{ ca_mount_path }}"
                        readOnly: true
      when: not ca_volume_exists

    - name: Restart SPIRE Server to apply configuration
      kubernetes.core.k8s:
        state: absent
        kind: Pod
        namespace: "{{ spire_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=server
      when: (not x509pop_exists) or (not ca_volume_exists)

    - name: Configuration status
      ansible.builtin.debug:
        msg: "{{ 'x509pop already configured' if (x509pop_exists and ca_volume_exists) else 'x509pop NodeAttestor plugin and CA volume mount configured successfully' }}"

    - name: Enable create-only mode on SpireServer CR
      ansible.builtin.debug:
        msg: "Enabling create-only mode to prevent operator from reverting x509pop configuration"

    - name: Set create-only annotation on SpireServer CR
      kubernetes.core.k8s:
        state: patched
        api_version: operator.openshift.io/v1alpha1
        kind: SpireServer
        name: cluster
        namespace: "{{ spire_namespace }}"
        definition:
          metadata:
            annotations:
              ztwim.openshift.io/create-only: "true"

    - name: Final status
      ansible.builtin.debug:
        msg: "x509pop configuration complete. Create-only mode enabled to preserve manual patches."
