{{- if .Values.rhtpa.syft.enabled }}
{{- if .Values.rhtpa.syft.scanner.enabled }}
---
# CronJob for scheduled SBOM generation
apiVersion: batch/v1
kind: CronJob
metadata:
  name: syft-sbom-scanner
  namespace: {{ .Values.rhtpa.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "26"
spec:
  suspend: {{ .Values.rhtpa.syft.scanner.suspend | default false }}
  schedule: {{ .Values.rhtpa.syft.scanner.schedule | quote }}
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: {{ .Values.rhtpa.syft.scanner.backoffLimit }}
      ttlSecondsAfterFinished: {{ .Values.rhtpa.syft.scanner.ttlSecondsAfterFinished | default 600 }}
      template:
        metadata:
          labels:
            app: syft-sbom-scanner
            component: sbom-scanner
            cronjob: "true"
        spec:
          serviceAccountName: syft
          restartPolicy: {{ .Values.rhtpa.syft.scanner.restartPolicy }}
          shareProcessNamespace: true  # Allow containers to signal each other
          
          initContainers:
          # Copy system CA bundle for syft (minimal syft image lacks public root CAs)
          - name: setup-ca-bundle
            image: registry.redhat.io/ubi9/ubi:latest
            command:
            - sh
            - -c
            - |
              echo "Copying system CA bundle for syft container..."
              # UBI has public root CAs, syft image doesn't
              if [ -f /etc/pki/tls/certs/ca-bundle.crt ]; then
                cp /etc/pki/tls/certs/ca-bundle.crt /ca-copy/system-ca-bundle.crt
                echo "System CA bundle copied ($(wc -l < /ca-copy/system-ca-bundle.crt) lines)"
              else
                echo "ERROR: System CA bundle not found in UBI image!"
                exit 1
              fi
            volumeMounts:
            - name: ca-copy
              mountPath: /ca-copy
          
          {{- if gt (int .Values.rhtpa.syft.scanner.healthCheckTimeout) 0 }}
          # Wait for RHTPA server to be ready with health check
          - name: wait-for-rhtpa
            image: registry.redhat.io/ubi9/ubi:latest
            command:
            - sh
            - -c
            - |
              echo "Checking RHTPA server health..."
              SERVER_URL="https://server.{{ .Values.rhtpa.namespace }}.svc.cluster.local"
              MAX_WAIT={{ .Values.rhtpa.syft.scanner.healthCheckTimeout }}
              INTERVAL=5
              
              i=0
              while [ $i -lt $MAX_WAIT ]; do
                if curl -k -s -f "${SERVER_URL}/health/ready" >/dev/null 2>&1; then
                  echo "RHTPA server is ready! (after ${i} seconds)"
                  exit 0
                fi
                echo "Waiting for RHTPA server... (${i}/${MAX_WAIT}s)"
                sleep $INTERVAL
                i=$((i + INTERVAL))
              done
              echo "ERROR: RHTPA server not ready after ${MAX_WAIT} seconds"
              exit 1
          {{- end }}
          
          # Wait for SPIFFE workload API socket
          - name: wait-for-spiffe
            image: registry.redhat.io/ubi9/ubi:latest
            command:
            - sh
            - -c
            - |
              echo "Waiting for SPIFFE workload API socket..."
              i=0
              while [ $i -lt 30 ]; do
                if [ -S /spiffe-workload-api/spire-agent.sock ]; then
                  echo "SPIFFE socket found!"
                  exit 0
                fi
                i=$((i + 1))
                echo "Waiting... ($i/30)"
                sleep 2
              done
              echo "ERROR: SPIFFE socket not found after 60 seconds"
              exit 1
            volumeMounts:
            - name: spiffe-workload-api
              mountPath: /spiffe-workload-api
              readOnly: true
          
          containers:
          # SPIFFE Helper - Generates JWT tokens (Sidecar)
          - name: spiffe-helper
            image: ghcr.io/spiffe/spiffe-helper:0.10.1
            imagePullPolicy: IfNotPresent
            args:
            - -config
            - /spiffe-config/helper.conf
            env:
            - name: SPIFFE_ENDPOINT_SOCKET
              value: unix:///spiffe-workload-api/spire-agent.sock
            volumeMounts:
            - name: spiffe-workload-api
              mountPath: /spiffe-workload-api
              readOnly: true
            - name: spiffe-config
              mountPath: /spiffe-config
              readOnly: true
            - name: spiffe-jwt
              mountPath: /run/secrets/spiffe
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"
          
          # SYFT Generator - Generates SBOMs using Red Hat syft image
          - name: syft-generator
            image: {{ .Values.rhtpa.syft.syftImage }}
            imagePullPolicy: IfNotPresent
            command: ["/bin/sh", "/scripts/generate-sboms.sh"]
            env:
            - name: HOME
              value: "/tmp"
            - name: SYFT_CACHE_DIR
              value: /tmp/.cache/syft
            volumeMounts:
            - name: generator-script
              mountPath: /scripts
              readOnly: true
            - name: images-config
              mountPath: /config
              readOnly: true
            - name: sboms
              mountPath: /sboms
            - name: ca-copy
              mountPath: /ca-bundle
              readOnly: true
            - name: service-ca
              mountPath: /etc/pki/ca-trust/extracted/pem
              readOnly: true
            - name: ingress-ca
              mountPath: /etc/pki/ca-trust/source/anchors
              readOnly: true
            resources:
              requests:
                memory: "256Mi"
                cpu: "200m"
              limits:
                memory: "1Gi"
                cpu: "1000m"
          
          # SBOM Uploader - Uploads SBOMs using Python UBI image
          - name: sbom-uploader
            image: {{ .Values.rhtpa.syft.uploaderImage }}
            imagePullPolicy: IfNotPresent
            command: ["/bin/bash", "/scripts/upload-sboms.sh"]
            env:
            - name: HOME
              value: "/tmp"
            # RHTPA API Upload Configuration
            - name: RHTPA_API_URL
              {{- if .Values.rhtpa.syft.apiUrl }}
              value: {{ .Values.rhtpa.syft.apiUrl | quote }}
              {{- else }}
              value: "https://server.{{ .Values.rhtpa.namespace }}.svc.cluster.local"
              {{- end }}
            - name: OIDC_ISSUER_URL
              value: {{ include "rhtpa-operator.keycloakOIDCIssuer" . | quote }}
            - name: OIDC_CLIENT_ID
              value: {{ .Values.rhtpa.zeroTrust.keycloak.clients.cli.clientId | default "rhtpa-cli" | quote }}
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.rhtpa.zeroTrust.keycloak.clients.cli.secretName | default "rhtpa-oidc-cli-secret" }}
                  key: client-secret
            volumeMounts:
            - name: uploader-scripts
              mountPath: /scripts
              readOnly: true
            - name: sboms
              mountPath: /sboms
              readOnly: true
            - name: spiffe-jwt
              mountPath: /run/secrets/spiffe
              readOnly: true
            - name: service-ca
              mountPath: /var/run/secrets/kubernetes.io/serviceaccount
              readOnly: true
            - name: ingress-ca
              mountPath: /var/run/secrets/kubernetes.io/serviceaccount/ingress-ca
              readOnly: true
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"
          
          volumes:
          # SPIFFE CSI driver volume
          - name: spiffe-workload-api
            csi:
              driver: csi.spiffe.io
              readOnly: true
          
          # SPIFFE helper configuration
          - name: spiffe-config
            configMap:
              name: syft-spiffe-helper-config
              defaultMode: 0644
          
          # Shared volume for JWT tokens
          - name: spiffe-jwt
            emptyDir:
              medium: Memory
          
          # Shared volume for SBOMs (between generator and uploader)
          - name: sboms
            emptyDir: {}
          
          # Shared volume for system CA bundle (from init container to syft-generator)
          - name: ca-copy
            emptyDir: {}
          
          # SYFT generator script
          - name: generator-script
            configMap:
              name: syft-generator-script
              defaultMode: 0755
          
          # SBOM uploader scripts (bash + Python combined)
          - name: uploader-scripts
            projected:
              defaultMode: 0755
              sources:
              - configMap:
                  name: sbom-uploader-script
              - configMap:
                  name: syft-python-scripts
          
          # Images configuration (list of images to scan)
          - name: images-config
            configMap:
              name: syft-images-config
          
          # OpenShift service CA bundle for SSL verification
          - name: service-ca
            configMap:
              name: syft-service-ca
              items:
              - key: service-ca.crt
                path: service-ca.crt
          
          # OpenShift Ingress CA bundle for OIDC verification
          - name: ingress-ca
            configMap:
              name: rhtpa-ingress-ca
              items:
              - key: ca.crt
                path: ca.crt
{{- end }}
{{- end }}
