{{- if .Values.rhtpa.tls.ingressCA.enabled }}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rhtpa-ingress-ca-extractor
  namespace: {{ .Values.rhtpa.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/hook: PreSync
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rhtpa-ingress-ca-extractor
  namespace: {{ .Values.rhtpa.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/hook: PreSync
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rhtpa-ingress-ca-extractor
  namespace: {{ .Values.rhtpa.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/hook: PreSync
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rhtpa-ingress-ca-extractor
subjects:
- kind: ServiceAccount
  name: rhtpa-ingress-ca-extractor
  namespace: {{ .Values.rhtpa.namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: rhtpa-ingress-ca-reader
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/hook: PreSync
rules:
# Read ingress CA from router secret
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["router-certs-default"]
  verbs: ["get"]
# Read OpenShift service CA (for NooBaa S3 TLS)
- apiGroups: [""]
  resources: ["configmaps"]
  resourceNames: ["openshift-service-ca.crt"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: rhtpa-ingress-ca-reader-{{ .Values.rhtpa.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    argocd.argoproj.io/hook: PreSync
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: rhtpa-ingress-ca-reader
subjects:
- kind: ServiceAccount
  name: rhtpa-ingress-ca-extractor
  namespace: {{ .Values.rhtpa.namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: rhtpa-ingress-ca-extractor
  namespace: {{ .Values.rhtpa.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  template:
    spec:
      serviceAccountName: rhtpa-ingress-ca-extractor
      restartPolicy: OnFailure
      containers:
      - name: extractor
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Extracting OpenShift ingress CA certificate..."
          
          # Extract the ingress certificate from the router secret
          oc get secret router-certs-default -n openshift-ingress -o jsonpath='{.data.tls\.crt}' | base64 -d > /tmp/ingress-ca.crt
          
          # Create or update the ingress CA ConfigMap (for backward compatibility)
          oc create configmap rhtpa-ingress-ca -n {{ .Values.rhtpa.namespace }} \
            --from-file=ca.crt=/tmp/ingress-ca.crt \
            --dry-run=client -o yaml | oc apply -f -
          
          echo "Ingress CA certificate extracted"
          
          # Extract the OpenShift service CA (for NooBaa S3 and other internal services)
          echo "Extracting OpenShift service CA certificate..."
          oc get configmap openshift-service-ca.crt -n openshift-config-managed -o jsonpath='{.data.service-ca\.crt}' > /tmp/service-ca.crt
          
          # Combine both CAs into a single bundle for RHTPA
          # This allows the Trustify server to trust both:
          # - External routes (Keycloak via ingress CA)
          # - Internal services (NooBaa S3 via service CA)
          echo "Creating combined CA bundle..."
          cat /tmp/ingress-ca.crt /tmp/service-ca.crt > /tmp/combined-ca.crt
          
          # Create the combined CA ConfigMap
          oc create configmap rhtpa-combined-ca -n {{ .Values.rhtpa.namespace }} \
            --from-file=combined-ca.crt=/tmp/combined-ca.crt \
            --dry-run=client -o yaml | oc apply -f -
          
          echo "Combined CA bundle created (ingress CA + service CA)"
{{- end }}

