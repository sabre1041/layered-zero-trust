# Sealed Secret for SPIRE agent x509pop attestation
#
# This creates a K8s Secret with sealed secret references that CDH will unseal
# inside the TEE after successful hardware attestation.
#
# Format: sealed.fakejwsheader.<base64-json>.fakesignature
# The JSON payload contains the KBS resource path, and CDH fetches the real secret.
#
{{- define "hello-coco.sealedRef" -}}
{{- $json := printf `{"version":"0.1.0","type":"vault","name":"kbs:///%s","provider":"kbs","provider_settings":{},"annotations":{}}` . -}}
sealed.fakejwsheader.{{ $json | b64enc }}.fakesignature
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.sealedSecret.name }}
  namespace: zero-trust-workload-identity-manager
type: Opaque
stringData:
  cert.pem: {{ include "hello-coco.sealedRef" .Values.sealedSecret.certPath | quote }}
  key.pem: {{ include "hello-coco.sealedRef" .Values.sealedSecret.keyPath | quote }}
