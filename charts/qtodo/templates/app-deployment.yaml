apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    argocd.argoproj.io/sync-wave: '20'
  labels:
    app: qtodo
    ztvp.io/uses-certificates: "true"
  name: qtodo
  namespace: qtodo
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      deployment: qtodo
  template:
    metadata:
      annotations:
        checksum/app-configmap-envvars: {{ include (print $.Template.BasePath "/app-config-env.yaml") . | sha256sum }}
{{- if eq .Values.app.spire.enabled true }}
        checksum/app-spiffe-helper-config: {{ include (print $.Template.BasePath "/spiffe-helper-config.yaml") . | sha256sum }}
        checksum/app-spiffe-vault-client-config: {{ include (print $.Template.BasePath "/spiffe-vault-client-config.yaml") . | sha256sum }}
{{- end }}
      labels:
        app: qtodo
        deployment: qtodo
      name: qtodo
    spec:
{{- if eq .Values.app.spire.enabled true }}
      initContainers:
      - name: init-ca-truststore
        image: registry.redhat.io/ubi9/openjdk-17:latest
        imagePullPolicy: IfNotPresent
        command:
          - /bin/bash
          - -c
          - |
            set -e
            echo "Converting CA bundle to PKCS12 truststore using Java KeyStore API..."
            
            # Validate password is provided
            if [ -z "$TRUSTSTORE_PASSWORD" ]; then
              echo "ERROR: TRUSTSTORE_PASSWORD not set"
              exit 1
            fi
            
            CA_BUNDLE="/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem"
            TRUSTSTORE_PATH="/run/secrets/truststore/truststore.p12"
            
            # Verify CA bundle exists
            if [ ! -f "$CA_BUNDLE" ]; then
              echo "ERROR: CA bundle not found at $CA_BUNDLE"
              exit 1
            fi
            
            # Count certificates in bundle
            CERT_COUNT=$(grep -c "BEGIN CERTIFICATE" "$CA_BUNDLE" || echo "0")
            echo "Found $CERT_COUNT certificates in CA bundle"
            
            # Use jshell to bulk-import all certificates (single JVM, much faster than keytool loop)
            jshell -R-Dpassword="$TRUSTSTORE_PASSWORD" -R-Dbundle="$CA_BUNDLE" -R-Doutput="$TRUSTSTORE_PATH" <<'JSHELL'
            import java.security.*;
            import java.security.cert.*;
            import java.io.*;
            import java.nio.file.*;
            
            String password = System.getProperty("password");
            String bundlePath = System.getProperty("bundle");
            String outputPath = System.getProperty("output");
            
            KeyStore ks = KeyStore.getInstance("PKCS12");
            ks.load(null, password.toCharArray());
            
            CertificateFactory cf = CertificateFactory.getInstance("X.509");
            byte[] pemBytes = Files.readAllBytes(Path.of(bundlePath));
            
            var certs = cf.generateCertificates(new ByteArrayInputStream(pemBytes));
            int i = 0;
            for (var cert : certs) {
                ks.setCertificateEntry("ztvp-ca-" + String.format("%03d", i++), cert);
            }
            
            try (FileOutputStream fos = new FileOutputStream(outputPath)) {
                ks.store(fos, password.toCharArray());
            }
            System.out.println("Imported " + i + " certificates into PKCS12 truststore");
            /exit
            JSHELL
            
            echo "Successfully created PKCS12 truststore"
            ls -lh "$TRUSTSTORE_PATH"
        env:
          - name: TRUSTSTORE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: qtodo-truststore-secret
                key: truststore-password
        volumeMounts:
          - name: ztvp-trusted-ca
            mountPath: /etc/pki/ca-trust/extracted/pem
            readOnly: true
          - name: truststore
            mountPath: /run/secrets/truststore
      - name: wait-for-keycloak
        image: registry.redhat.io/openshift4/ose-tools-rhel9:latest
        imagePullPolicy: IfNotPresent
        command:
          - /bin/sh
          - -c
          - |
            echo "Waiting for Keycloak OIDC endpoint to be available..."
            KEYCLOAK_URL="{{ default (printf "https://keycloak.%s/realms/ztvp/.well-known/openid-configuration" .Values.global.localClusterDomain) .Values.app.oidc.authServerUrl }}/.well-known/openid-configuration"
            # Remove duplicate .well-known if authServerUrl already contains realm
            KEYCLOAK_URL=$(echo "$KEYCLOAK_URL" | sed 's|/.well-known/openid-configuration/.well-known/openid-configuration|/.well-known/openid-configuration|')
            
            MAX_RETRIES=60
            RETRY_INTERVAL=5
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -sf --cacert /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem "$KEYCLOAK_URL" > /dev/null 2>&1; then
                echo "Keycloak is available!"
                exit 0
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Keycloak not ready yet (attempt $RETRY_COUNT/$MAX_RETRIES). Retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            done
            
            echo "WARNING: Keycloak not available after $MAX_RETRIES attempts. Continuing anyway..."
            exit 0
        volumeMounts:
          - name: ztvp-trusted-ca
            mountPath: /etc/pki/ca-trust/extracted/pem
            readOnly: true
      - name: init-spiffe-helper
        image: {{ template "qtodo.image" .Values.app.images.spiffeHelper }}
        imagePullPolicy: {{ .Values.app.images.spiffeHelper.pullPolicy }}
        args:
          - '-config'
          - /etc/helper.conf
          - '-daemon-mode=false'
        volumeMounts:
          - name: spiffe-helper-config
            readOnly: true
            mountPath: /etc/helper.conf
            subPath: helper.conf
          - name: spiffe-workload-api
            readOnly: true
            mountPath: /spiffe-workload-api
          - name: svids
            mountPath: /svids
      - name: init-spiffe-vault-client
        image: {{ template "qtodo.image" .Values.app.images.spiffeVaultClient }}
        imagePullPolicy: {{ .Values.app.images.spiffeVaultClient.pullPolicy }}
        command:
          - python3
          - /opt/app-root/src/spiffe-vault-client.py
          - '--init'
        env:
          - name: VAULT_URL
            value: {{ .Values.app.vault.url }}
          - name: VAULT_ROLE
            value: {{ .Values.app.vault.role }}
          - name: VAULT_SECRET_PATH
            value: {{ .Values.app.vault.secretPath }}
          - name: DB_USERNAME
            value: {{ .Values.postgresql.auth.username }}
          - name: CREDENTIALS_FILE
            value: /run/secrets/db-credentials/credentials.properties
          - name: JWT_TOKEN_FILE
            value: /svids/jwt.token
          - name: ZTVP_CA_BUNDLE
            value: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
        volumeMounts:
          - name: svids
            mountPath: /svids
          - name: db-credentials
            mountPath: /run/secrets/db-credentials
          - name: spiffe-vault-client
            mountPath: /opt/app-root/src
          - name: ztvp-trusted-ca
            mountPath: /etc/pki/ca-trust/extracted/pem
            readOnly: true
{{- end }}
      containers:
{{- if and .Values.app.spire.enabled .Values.app.spire.sidecars }}
      - name: spiffe-helper
        image: {{ template "qtodo.image" .Values.app.images.spiffeHelper }}
        imagePullPolicy: {{ .Values.app.images.spiffeHelper.pullPolicy }}
        args:
          - '-config'
          - /etc/helper.conf
        resources: {}
        volumeMounts:
          - name: spiffe-helper-config
            readOnly: true
            mountPath: /etc/helper.conf
            subPath: helper.conf
          - name: spiffe-workload-api
            readOnly: true
            mountPath: /spiffe-workload-api
          - name: svids
            mountPath: /svids
      - name: spiffe-vault-client
        image: {{ template "qtodo.image" .Values.app.images.spiffeVaultClient }}
        imagePullPolicy: {{ .Values.app.images.spiffeVaultClient.pullPolicy }}
        command:
        - python3
        - /opt/app-root/src/spiffe-vault-client.py
        resources: {}
        securityContext: {}
        env:
        - name: VAULT_URL
          value: {{ .Values.app.vault.url }}
        - name: VAULT_ROLE
          value: {{ .Values.app.vault.role }}
        - name: VAULT_SECRET_PATH
          value: {{ .Values.app.vault.secretPath }}
        - name: DB_USERNAME
          value: {{ .Values.postgresql.auth.username }}
        - name: CREDENTIALS_FILE
          value: /run/secrets/db-credentials/credentials.properties
        - name: JWT_TOKEN_FILE
          value: /svids/jwt.token
        - name: ZTVP_CA_BUNDLE
          value: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
        volumeMounts:
        - name: svids
          mountPath: /svids
          readOnly: true
        - name: db-credentials
          mountPath: /run/secrets/db-credentials
        - name: spiffe-vault-client
          mountPath: /opt/app-root/src
          readOnly: true
        - name: ztvp-trusted-ca
          mountPath: /etc/pki/ca-trust/extracted/pem
          readOnly: true
{{- end }}
      - name: qtodo
        image: {{ template "qtodo.image" .Values.app.images.main }}
        imagePullPolicy: {{ .Values.app.images.main.pullPolicy }}
        ports:
        - containerPort: 8080
          name: http
          protocol: TCP
        envFrom:
          - configMapRef:
              name: qtodo-config-env
        securityContext:
          privileged: false
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: RuntimeDefault
        env:
        - name: QUARKUS_DATASOURCE_JDBC_URL
          value: 'jdbc:postgresql://qtodo-db:5432/{{ .Values.postgresql.auth.database }}'
        - name: QUARKUS_HTTP_HOST
          value: '0.0.0.0'
        - name: QUARKUS_HTTP_PORT
          value: '8080'
        - name: QUARKUS_HIBERNATE_ORM_SCHEMA_MANAGEMENT_STRATEGY
          value: 'drop-and-create'
{{- if eq .Values.app.spire.enabled false }}
        - name: QUARKUS_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: {{ .Values.postgresql.auth.secretName }}
              key: username
        - name: QUARKUS_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.postgresql.auth.secretName }}
              key: password
{{- else }}
        - name: QUARKUS_CONFIG_LOCATIONS
          value: file:/run/secrets/db-credentials/credentials.properties
        - name: QUARKUS_OIDC_CREDENTIALS_SECRET
          valueFrom:
            secretKeyRef:
              name: oidc-client-secret
              key: client-secret
{{- if eq .Values.app.truststore.enabled true }}
        # Truststore password from Vault secret
        - name: TRUSTSTORE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: qtodo-truststore-secret
              key: truststore-password
        # JVM-level truststore configuration for all SSL connections (PKCS12 format)
        - name: JAVA_TOOL_OPTIONS
          value: "-Djavax.net.ssl.trustStore=/run/secrets/truststore/truststore.p12 -Djavax.net.ssl.trustStoreType=PKCS12 -Djavax.net.ssl.trustStorePassword=$(TRUSTSTORE_PASSWORD)"
{{- end }}
{{- end }}
{{- if eq .Values.app.spire.enabled true }}
        volumeMounts:
          - name: db-credentials
            mountPath: /run/secrets/db-credentials
          - name: truststore
            mountPath: /run/secrets/truststore
            readOnly: true
          # Mount ZTVP CA bundle for non-Java tools (curl, openssl, etc.)
          - name: ztvp-trusted-ca
            mountPath: /etc/pki/ca-trust/extracted/pem
            readOnly: true
{{- end }}
        resources: {}
      serviceAccountName: qtodo
{{- if eq .Values.app.spire.enabled true }}
      volumes:
        - name: spiffe-helper-config
          configMap:
            name: spiffe-helper
            defaultMode: 420
        - name: svids
          emptyDir: {}
        - name: spiffe-workload-api
          csi:
            driver: csi.spiffe.io
            readOnly: true
        - name: db-credentials
          emptyDir: {}
        - name: spiffe-vault-client
          configMap:
            name: spiffe-vault-client
        - name: ztvp-trusted-ca
          configMap:
            name: ztvp-trusted-ca
            defaultMode: 420
        - name: truststore
          emptyDir: {}
{{- end }}
